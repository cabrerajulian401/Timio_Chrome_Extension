(()=>{var e,t,r={7425:()=>{console.log("Background page running");const e="https://api.timio.news",t={GET_CONTENT:`${e}/api/content`,GET_INSIGHTS:`${e}/api/insights`,GET_TAGS:`${e}/api/tags`},r={log(e,t=null){const r={timestamp:(new Date).toISOString(),message:e,data:t?"string"==typeof t?t:{...t,sensitive:void 0}:null};console.log("TIMIO Extension:",r)},error(e,t=null){const r={timestamp:(new Date).toISOString(),message:e,error:t?.message||t,stack:t?.stack};console.error("TIMIO Extension ERROR:",r)}};chrome.runtime.onMessage.addListener((function(e,t,n){return"AUTH_STATE_CHANGED"===e.type&&(r.log("Auth state changed:",{isLoggedIn:e.isLoggedIn}),chrome.storage.local.set({isLoggedIn:e.isLoggedIn},(function(){chrome.runtime.lastError?r.error("Error saving auth state:",chrome.runtime.lastError):r.log("Auth state saved successfully")})),n({success:!0})),!0}));const n=()=>new Promise((e=>{chrome.storage.local.get(["isLoggedIn","authToken","userId"],(function(t){if(chrome.runtime.lastError)return r.error("Error accessing storage:",chrome.runtime.lastError),void e({isLoggedIn:!1});e({isLoggedIn:!!t.isLoggedIn,hasToken:!!t.authToken,userId:t.userId})}))}));chrome.runtime.onStartup.addListener((async function(){try{const e=await n();r.log("Extension started, auth state:",e)}catch(e){r.error("Error checking auth state on startup:",e)}}));const o={async set(e,t){try{r.log(`Setting cache for key: ${e}`),await chrome.storage.local.set({[e]:{data:t,timestamp:Date.now()}}),r.log(`Cache set successfully for key: ${e}`)}catch(t){throw r.error(`Failed to set cache for key: ${e}`,t),t}},async get(e){try{r.log(`Getting cache for key: ${e}`);const t=await chrome.storage.local.get(e);return r.log(`Cache retrieved for key: ${e}`),t[e]}catch(t){throw r.error(`Failed to get cache for key: ${e}`,t),t}},async clear(e){try{r.log("Clearing cache for keys:",e),await chrome.storage.local.remove(e),r.log("Cache cleared successfully")}catch(e){throw r.error("Failed to clear cache",e),e}},isExpired:e=>Date.now()-e>864e5},a={async fetchWithRetry(e,t,n=5){let o;r.log(`Making API request to: ${e}`,{method:t.method,hasBody:!!t.body});for(let a=0;a<n;a++)try{r.log(`Request attempt ${a+1} of ${n}`);const o="GET"===t.method&&t.params?`${e}?${new URLSearchParams(t.params)}`:e;console.log("finalUrl:",o),r.log("Request details:",{url:o,method:t.method,hasParams:!!t.params,hasBody:!!t.body});const i=await fetch(o,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!i.ok){const e=await i.text();throw new Error(`HTTP error! status: ${i.status}, details: ${e}`)}const c=await i.json();return r.log("API request successful",{status:i.status,hasData:!!c}),c}catch(e){if(o=e,r.error(`API request attempt ${a+1} failed`,e),a===n-1)break;const t=3e3*Math.pow(2,a);r.log(`Retrying in ${t}ms`),await new Promise((e=>setTimeout(e,t)))}throw o}},i={async getArticleContent(e,n=!0){r.log(`Getting article content for URL: ${e}`,{useCache:n});const i=`content_${e}`;if(n)try{const e=await o.get(i);if(e&&!o.isExpired(e.timestamp))return r.log("Returning cached content"),e.data}catch(e){r.error("Cache retrieval failed",e)}try{r.log("Fetching fresh content from API");const n=await a.fetchWithRetry(t.GET_CONTENT,{method:"GET",params:{article_url:e}});if(!n||!n.clean_text)throw new Error("Invalid content response from API");return await o.set(i,n),n}catch(e){throw r.error("Failed to get article content",e),e}},async getInsights(e,n,i=!0){const c=`insights_${n}`;if(i)try{const e=await o.get(c);if(e&&!o.isExpired(e.timestamp))return r.log("Returning cached insights"),e.data}catch(e){r.error("Cache retrieval failed",e)}try{if(r.log("Requesting insights analysis"),!e||!e.clean_text)throw new Error("Invalid content provided for insights");const n=await a.fetchWithRetry(t.GET_INSIGHTS,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e.clean_text})});return await o.set(c,n),n}catch(e){throw r.error("Failed to get insights",e),e}},async getTags(e,n,i=!0){const c=`tags_${n}`;if(i)try{const e=await o.get(c);if(e&&!o.isExpired(e.timestamp))return r.log("Returning cached tags"),e.data}catch(e){r.error("Cache retrieval failed",e)}try{if(r.log("Requesting content tags"),!e||!e.clean_text)throw new Error("Invalid content provided for tags");const n=await a.fetchWithRetry(t.GET_TAGS,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e.clean_text})});return await o.set(c,n),n}catch(e){throw r.error("Failed to get tags",e),e}}},c={ports:new Set,addPort(e){r.log(`New port connection: ${e.name}`),this.ports.add(e),e.onDisconnect.addListener((()=>{r.log(`Port disconnected: ${e.name}`),this.ports.delete(e)}))},isPortActive(e){const t=this.ports.has(e);return r.log(`Checking port status: ${e.name}`,{active:t}),t},sendMessage(e,t){this.isPortActive(e)&&(e.postMessage(t),r.log("Message sent through port",{type:t.error?"error":"success"}))}};chrome.runtime.onConnect.addListener((e=>{"timio-extension"===e.name?(r.log("New connection established"),c.addPort(e),e.onMessage.addListener((async t=>{r.log("Received message",{action:t.action});const n=setTimeout((()=>{c.isPortActive(e)&&(r.error("Operation timed out"),c.sendMessage(e,{error:"Operation timed out. Please try again."}))}),7e4);try{if(!c.isPortActive(e))return void r.log("Port is no longer active, ignoring message");switch(t.action){case"getInsights":try{console.log("current article url:",t.url),r.log("Processing getInsights request");const n=await i.getArticleContent(t.url);r.log("Content retrieved, fetching insights");const o=await i.getInsights(n,t.url);c.sendMessage(e,{insights:o})}catch(t){r.error("Failed to get insights",t),c.sendMessage(e,{error:"Unable to analyze this article."})}break;case"getPivotArticles":try{r.log("Processing getPivotArticles request");const n=await i.getArticleContent(t.url);r.log("Content retrieved, length:",{textLength:n.clean_text?.length,htmlLength:n.clean_html?.length});const o=await i.getTags(n,t.url);r.log("Related articles retrieved",{hasArticles:!!o,articleCount:Array.isArray(o)?o.length:"not an array"}),c.sendMessage(e,{articles:o})}catch(t){r.error("Failed to get related articles",t),c.sendMessage(e,{error:"Unable to find related articles."})}break;default:r.error(`Unknown action: ${t.action}`),c.sendMessage(e,{error:`Unknown action: ${t.action}`})}}catch(t){r.error("Unexpected error in message handler",t),c.sendMessage(e,{error:"An unexpected error occurred."})}finally{clearTimeout(n)}}))):r.log("Rejected connection with unexpected port name:",e.name)}));const s=async()=>{try{const{hasToken:e,isLoggedIn:t}=await n();!e&&t&&(await chrome.storage.local.set({isLoggedIn:!1}),r.log("Cleared inconsistent login state (no token)"))}catch(e){r.error("Auth validation error:",e)}};setInterval(s,36e5),chrome.runtime.onInstalled.addListener((function(e){r.log("Extension installed or updated",{reason:e.reason}),s()})),r.log("Background script initialized",{apiBaseUrl:e,endpoints:t})}},n={};function o(e){var t=n[e];if(void 0!==t){if(void 0!==t.error)throw t.error;return t.exports}var a=n[e]={exports:{}};try{var i={id:e,module:a,factory:r[e],require:o};o.i.forEach((function(e){e(i)})),a=i.module,i.factory.call(a.exports,a,a.exports,i.require)}catch(e){throw a.error=e,e}return a.exports}o.m=r,o.c=n,o.i=[],o.hu=e=>e+"."+o.h()+".hot-update.js",o.hmrF=()=>"background."+o.h()+".hot-update.json",o.h=()=>"a69d200a2aa2bcc3bb52",o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="chrome-extension-boilerplate-react:",o.l=(r,n,a,i)=>{if(e[r])e[r].push(n);else{var c,s;if(void 0!==a)for(var d=document.getElementsByTagName("script"),l=0;l<d.length;l++){var u=d[l];if(u.getAttribute("src")==r||u.getAttribute("data-webpack")==t+a){c=u;break}}c||(s=!0,(c=document.createElement("script")).charset="utf-8",c.timeout=120,o.nc&&c.setAttribute("nonce",o.nc),c.setAttribute("data-webpack",t+a),c.src=r),e[r]=[n];var h=(t,n)=>{c.onerror=c.onload=null,clearTimeout(f);var o=e[r];if(delete e[r],c.parentNode&&c.parentNode.removeChild(c),o&&o.forEach((e=>e(n))),t)return t(n)},f=setTimeout(h.bind(null,void 0,{type:"timeout",target:c}),12e4);c.onerror=h.bind(null,c.onerror),c.onload=h.bind(null,c.onload),s&&document.head.appendChild(c)}},(()=>{var e,t,r,n={},a=o.c,i=[],c=[],s="idle",d=0,l=[];function u(e){s=e;for(var t=[],r=0;r<c.length;r++)t[r]=c[r].call(null,e);return Promise.all(t).then((function(){}))}function h(){0==--d&&u("ready").then((function(){if(0===d){var e=l;l=[];for(var t=0;t<e.length;t++)e[t]()}}))}function f(e){if("idle"!==s)throw new Error("check() is only allowed in idle status");return u("check").then(o.hmrM).then((function(r){return r?u("prepare").then((function(){var n=[];return t=[],Promise.all(Object.keys(o.hmrC).reduce((function(e,a){return o.hmrC[a](r.c,r.r,r.m,e,t,n),e}),[])).then((function(){return t=function(){return e?g(e):u("ready").then((function(){return n}))},0===d?t():new Promise((function(e){l.push((function(){e(t())}))}));var t}))})):u(m()?"ready":"idle").then((function(){return null}))}))}function p(e){return"ready"!==s?Promise.resolve().then((function(){throw new Error("apply() is only allowed in ready status (state: "+s+")")})):g(e)}function g(e){e=e||{},m();var n=t.map((function(t){return t(e)}));t=void 0;var o=n.map((function(e){return e.error})).filter(Boolean);if(o.length>0)return u("abort").then((function(){throw o[0]}));var a=u("dispose");n.forEach((function(e){e.dispose&&e.dispose()}));var i,c=u("apply"),s=function(e){i||(i=e)},d=[];return n.forEach((function(e){if(e.apply){var t=e.apply(s);if(t)for(var r=0;r<t.length;r++)d.push(t[r])}})),Promise.all([a,c]).then((function(){return i?u("fail").then((function(){throw i})):r?g(e).then((function(e){return d.forEach((function(t){e.indexOf(t)<0&&e.push(t)})),e})):u("idle").then((function(){return d}))}))}function m(){if(r)return t||(t=[]),Object.keys(o.hmrI).forEach((function(e){r.forEach((function(r){o.hmrI[e](r,t)}))})),r=void 0,!0}o.hmrD=n,o.i.push((function(l){var g,m,y,v,w=l.module,E=function(t,r){var n=a[r];if(!n)return t;var o=function(o){if(n.hot.active){if(a[o]){var c=a[o].parents;-1===c.indexOf(r)&&c.push(r)}else i=[r],e=o;-1===n.children.indexOf(o)&&n.children.push(o)}else console.warn("[HMR] unexpected require("+o+") from disposed module "+r),i=[];return t(o)},c=function(e){return{configurable:!0,enumerable:!0,get:function(){return t[e]},set:function(r){t[e]=r}}};for(var l in t)Object.prototype.hasOwnProperty.call(t,l)&&"e"!==l&&Object.defineProperty(o,l,c(l));return o.e=function(e,r){return function(e){switch(s){case"ready":u("prepare");case"prepare":return d++,e.then(h,h),e;default:return e}}(t.e(e,r))},o}(l.require,l.id);w.hot=(g=l.id,m=w,v={_acceptedDependencies:{},_acceptedErrorHandlers:{},_declinedDependencies:{},_selfAccepted:!1,_selfDeclined:!1,_selfInvalidated:!1,_disposeHandlers:[],_main:y=e!==g,_requireSelf:function(){i=m.parents.slice(),e=y?void 0:g,o(g)},active:!0,accept:function(e,t,r){if(void 0===e)v._selfAccepted=!0;else if("function"==typeof e)v._selfAccepted=e;else if("object"==typeof e&&null!==e)for(var n=0;n<e.length;n++)v._acceptedDependencies[e[n]]=t||function(){},v._acceptedErrorHandlers[e[n]]=r;else v._acceptedDependencies[e]=t||function(){},v._acceptedErrorHandlers[e]=r},decline:function(e){if(void 0===e)v._selfDeclined=!0;else if("object"==typeof e&&null!==e)for(var t=0;t<e.length;t++)v._declinedDependencies[e[t]]=!0;else v._declinedDependencies[e]=!0},dispose:function(e){v._disposeHandlers.push(e)},addDisposeHandler:function(e){v._disposeHandlers.push(e)},removeDisposeHandler:function(e){var t=v._disposeHandlers.indexOf(e);t>=0&&v._disposeHandlers.splice(t,1)},invalidate:function(){switch(this._selfInvalidated=!0,s){case"idle":t=[],Object.keys(o.hmrI).forEach((function(e){o.hmrI[e](g,t)})),u("ready");break;case"ready":Object.keys(o.hmrI).forEach((function(e){o.hmrI[e](g,t)}));break;case"prepare":case"check":case"dispose":case"apply":(r=r||[]).push(g)}},check:f,apply:p,status:function(e){if(!e)return s;c.push(e)},addStatusHandler:function(e){c.push(e)},removeStatusHandler:function(e){var t=c.indexOf(e);t>=0&&c.splice(t,1)},data:n[g]},e=void 0,v),w.parents=i,w.children=[],i=[],l.require=E})),o.hmrC={},o.hmrI={}})(),o.p="/",(()=>{var e,t,r,n,a,i=o.hmrS_jsonp=o.hmrS_jsonp||{471:0},c={};function s(t,r){return e=r,new Promise(((e,r)=>{c[t]=e;var n=o.p+o.hu(t),a=new Error;o.l(n,(e=>{if(c[t]){c[t]=void 0;var n=e&&("load"===e.type?"missing":e.type),o=e&&e.target&&e.target.src;a.message="Loading hot update chunk "+t+" failed.\n("+n+": "+o+")",a.name="ChunkLoadError",a.type=n,a.request=o,r(a)}}))}))}function d(e){function c(e){for(var t=[e],r={},n=t.map((function(e){return{chain:[e],id:e}}));n.length>0;){var a=n.pop(),i=a.id,c=a.chain,d=o.c[i];if(d&&(!d.hot._selfAccepted||d.hot._selfInvalidated)){if(d.hot._selfDeclined)return{type:"self-declined",chain:c,moduleId:i};if(d.hot._main)return{type:"unaccepted",chain:c,moduleId:i};for(var l=0;l<d.parents.length;l++){var u=d.parents[l],h=o.c[u];if(h){if(h.hot._declinedDependencies[i])return{type:"declined",chain:c.concat([u]),moduleId:i,parentId:u};-1===t.indexOf(u)&&(h.hot._acceptedDependencies[i]?(r[u]||(r[u]=[]),s(r[u],[i])):(delete r[u],t.push(u),n.push({chain:c.concat([u]),id:u})))}}}}return{type:"accepted",moduleId:e,outdatedModules:t,outdatedDependencies:r}}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];-1===e.indexOf(n)&&e.push(n)}}o.f&&delete o.f.jsonpHmr,t=void 0;var d={},l=[],u={},h=function(e){console.warn("[HMR] unexpected require("+e.id+") to disposed module")};for(var f in r)if(o.o(r,f)){var p,g=r[f],m=!1,y=!1,v=!1,w="";switch((p=g?c(f):{type:"disposed",moduleId:f}).chain&&(w="\nUpdate propagation: "+p.chain.join(" -> ")),p.type){case"self-declined":e.onDeclined&&e.onDeclined(p),e.ignoreDeclined||(m=new Error("Aborted because of self decline: "+p.moduleId+w));break;case"declined":e.onDeclined&&e.onDeclined(p),e.ignoreDeclined||(m=new Error("Aborted because of declined dependency: "+p.moduleId+" in "+p.parentId+w));break;case"unaccepted":e.onUnaccepted&&e.onUnaccepted(p),e.ignoreUnaccepted||(m=new Error("Aborted because "+f+" is not accepted"+w));break;case"accepted":e.onAccepted&&e.onAccepted(p),y=!0;break;case"disposed":e.onDisposed&&e.onDisposed(p),v=!0;break;default:throw new Error("Unexception type "+p.type)}if(m)return{error:m};if(y)for(f in u[f]=g,s(l,p.outdatedModules),p.outdatedDependencies)o.o(p.outdatedDependencies,f)&&(d[f]||(d[f]=[]),s(d[f],p.outdatedDependencies[f]));v&&(s(l,[p.moduleId]),u[f]=h)}r=void 0;for(var E,I=[],_=0;_<l.length;_++){var b=l[_],k=o.c[b];k&&(k.hot._selfAccepted||k.hot._main)&&u[b]!==h&&!k.hot._selfInvalidated&&I.push({module:b,require:k.hot._requireSelf,errorHandler:k.hot._selfAccepted})}return{dispose:function(){var e;n.forEach((function(e){delete i[e]})),n=void 0;for(var t,r=l.slice();r.length>0;){var a=r.pop(),c=o.c[a];if(c){var s={},u=c.hot._disposeHandlers;for(_=0;_<u.length;_++)u[_].call(null,s);for(o.hmrD[a]=s,c.hot.active=!1,delete o.c[a],delete d[a],_=0;_<c.children.length;_++){var h=o.c[c.children[_]];h&&((e=h.parents.indexOf(a))>=0&&h.parents.splice(e,1))}}}for(var f in d)if(o.o(d,f)&&(c=o.c[f]))for(E=d[f],_=0;_<E.length;_++)t=E[_],(e=c.children.indexOf(t))>=0&&c.children.splice(e,1)},apply:function(t){for(var r in u)o.o(u,r)&&(o.m[r]=u[r]);for(var n=0;n<a.length;n++)a[n](o);for(var i in d)if(o.o(d,i)){var c=o.c[i];if(c){E=d[i];for(var s=[],h=[],f=[],p=0;p<E.length;p++){var g=E[p],m=c.hot._acceptedDependencies[g],y=c.hot._acceptedErrorHandlers[g];if(m){if(-1!==s.indexOf(m))continue;s.push(m),h.push(y),f.push(g)}}for(var v=0;v<s.length;v++)try{s[v].call(null,E)}catch(r){if("function"==typeof h[v])try{h[v](r,{moduleId:i,dependencyId:f[v]})}catch(n){e.onErrored&&e.onErrored({type:"accept-error-handler-errored",moduleId:i,dependencyId:f[v],error:n,originalError:r}),e.ignoreErrored||(t(n),t(r))}else e.onErrored&&e.onErrored({type:"accept-errored",moduleId:i,dependencyId:f[v],error:r}),e.ignoreErrored||t(r)}}}for(var w=0;w<I.length;w++){var _=I[w],b=_.module;try{_.require(b)}catch(r){if("function"==typeof _.errorHandler)try{_.errorHandler(r,{moduleId:b,module:o.c[b]})}catch(n){e.onErrored&&e.onErrored({type:"self-accept-error-handler-errored",moduleId:b,error:n,originalError:r}),e.ignoreErrored||(t(n),t(r))}else e.onErrored&&e.onErrored({type:"self-accept-errored",moduleId:b,error:r}),e.ignoreErrored||t(r)}}return l}}}self.webpackHotUpdatechrome_extension_boilerplate_react=(t,n,i)=>{for(var s in n)o.o(n,s)&&(r[s]=n[s],e&&e.push(s));i&&a.push(i),c[t]&&(c[t](),c[t]=void 0)},o.hmrI.jsonp=function(e,t){r||(r={},a=[],n=[],t.push(d)),o.o(r,e)||(r[e]=o.m[e])},o.hmrC.jsonp=function(e,c,l,u,h,f){h.push(d),t={},n=c,r=l.reduce((function(e,t){return e[t]=!1,e}),{}),a=[],e.forEach((function(e){o.o(i,e)&&void 0!==i[e]?(u.push(s(e,f)),t[e]=!0):t[e]=!1})),o.f&&(o.f.jsonpHmr=function(e,r){t&&o.o(t,e)&&!t[e]&&(r.push(s(e)),t[e]=!0)})},o.hmrM=()=>{if("undefined"==typeof fetch)throw new Error("No browser support: need fetch API");return fetch(o.p+o.hmrF()).then((e=>{if(404!==e.status){if(!e.ok)throw new Error("Failed to fetch update manifest "+e.statusText);return e.json()}}))}})();o(7425)})();